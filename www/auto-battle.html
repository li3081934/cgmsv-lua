<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <link rel="stylesheet" href="css/card.css" />
    <script src="js/gb18030ToUtf8.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        const { createApp, ref, reactive, onMounted, defineEmits } = Vue
        const App = {
            setup() {
                const autoBattleChar = ref([]);
                const onLineChar = ref([]);

                function getAutoBattleChar() {
                    axios.post('/api/getAutoBattleChar').then(res => {
                        autoBattleChar.value = res.data.data;
                        refreshOnlineStatus()
                    })
                }

                function getOnlineChar() {
                    axios.post('/api/getOnlineChar').then(res => {
                        onLineChar.value = res.data.data;
                        refreshOnlineStatus()
                    })
                }
                function refreshOnlineStatus() {
                    if (!onLineChar.value.length) {
                        return;
                    }
                    onLineChar.value = onLineChar.value.map(item => {
                        return {
                            ...item, 
                            autoBattle: autoBattleChar.value.find(char => char.charIndex === item.charIndex) ? 1 : 0
                        }
                    })
                }

                function autoBattleStop() {
                    axios.post('/api/autoBattleStop', { charIndex: charIndex }).then(res => {
                        if (res.data.success) {
                            ElementPlus.ElNotification({
                                title: 'Success',
                                message: '停止成功',
                                type: 'success',
                            })
                            getAutoBattleChar();
                        }
                    })
                }

                function autoBattleStart() {
                    axios.post('/api/autoBattleStart', { charIndex: charIndex }).then(res => {
                        if (res.data.success) {
                            ElementPlus.ElNotification({
                                title: 'Success',
                                message: '开启成功',
                                type: 'success',
                            })
                            getAutoBattleChar();
                        }
                    })
                }

                function onChangeAutoBattle(char, val) {
                    char.autoBattle = char ? 1 : 0;
                    if (val) {
                        autoBattleStart();
                    } else {
                        autoBattleStop();
                    }

                }
                
                onMounted(() => {
                    getAutoBattleChar();
                    getOnlineChar();
                })
                return {
                    autoBattleChar, getAutoBattleChar, getOnlineChar, onLineChar, onChangeAutoBattle
                }
            }
        };
        const app = Vue.createApp(App);
        app.use(ElementPlus);
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component)
        }
        
    </script>
</head>

<body>
    <div id="app">
        <div class="list-title">在线的角色<el-icon class="op-icon" @click="getOnlineChar"><Refresh /></el-icon></div>
        <el-table :data="onLineChar" style="width: 100%" border>
            <el-table-column prop="charIndex" label="Char Index"  />
            <el-table-column prop="charName" label="名字" />
            <el-table-column label="自动战斗开关">
                <template #default="scope">
                  <nz-switch [ngModel]="scope.row.autoBattle === 1" @change="(val) =>onChangeAutoBattle(scope.row, val)" nzCheckedChildren="开" nzUnCheckedChildren="关"></nz-switch>
                </template>
              </el-table-column>
            
        </el-table>
        <div class="list-title">自动战斗的角色<el-icon class="op-icon" @click="getAutoBattleChar"><Refresh /></el-icon></div>
        <el-row :gutter="16">
            <el-col style="margin-bottom: 16px;" :xs="24" :sm="12" :md="12" :lg="8" :xl="6" v-for="item in autoBattleChar" :key="item.charIndex">
                <user-card :char-index="item.charIndex" :char-name="item.charName" @refresh-char="getAutoBattleChar"></user-card>
            </el-col>
          </el-row>
        
    </div>
    
    
    <script src="js/user-card.js"></script>
    <script>
        app.mount("#app");
    </script>
</body>

</html>